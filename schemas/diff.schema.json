{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://chimera-trunk.dev/schemas/diff.schema.json",
  "title": "Diff Artifact (diff.json) Schema",
  "description": "Validates the diff.json artifact, the final machine-readable output of the change set (the WHAT). Each change item represents a discrete file operation with full post-change content for ADD/MODIFY, or an empty content string for DELETE.",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_version", "run_id", "author", "changes"],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Version of the diff artifact schema itself. Controls migrations for this contract.",
      "pattern": "^1\\.0$",
      "examples": ["1.0"]
    },
    "run_id": {
      "type": "string",
      "description": "Unique, human-readable identifier tying this diff to a specific change set (matches intent/instructions).",
      "minLength": 1,
      "examples": ["20251003-refactor-auth-module", "20251003-add-ci-gate"]
    },
    "author": {
      "type": "object",
      "description": "Metadata identifying the actor who authored this diff artifact. Only an actor in the BRANCH role may author the final changeset.",
      "additionalProperties": false,
      "required": ["actor", "role", "timestamp"],
      "properties": {
        "actor": {
          "type": "string",
          "description": "Structured identifier of the author (e.g., username:Dev1). Must match the allowed namespace and should correspond to an entry in chimera.yaml roles.BRANCH. Cross-reference is enforced by the CLI validator.",
          "pattern": "^(?:username|email|agent):.+$",
          "examples": ["username:Dev1", "email:executor@example.com", "agent:codegen-worker-a"]
        },
        "role": {
          "type": "string",
          "description": "Role assumed by the author for this action. For the diff, only BRANCH is permitted.",
          "enum": ["BRANCH"],
          "examples": ["BRANCH"]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when the diff was created.",
          "examples": ["2025-10-03T15:44:30Z"]
        }
      }
    },
    "changes": {
      "type": "array",
      "description": "A list of discrete file system changes that constitute the final diff.",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["file_path", "change_type", "content"],
        "properties": {
          "file_path": {
            "type": "string",
            "description": "Relative path to the file being changed. Paths should be project-relative and use POSIX-style separators.",
            "minLength": 1,
            "examples": [
              "./src/components/RaceCar.tsx",
              "./server/auth/oauth2.ts",
              ".github/workflows/chimera-gate.yml"
            ]
          },
          "change_type": {
            "type": "string",
            "description": "Nature of the change to the file.",
            "enum": ["ADD", "MODIFY", "DELETE"],
            "examples": ["ADD", "MODIFY", "DELETE"]
          },
          "content": {
            "type": "string",
            "description": "For ADD and MODIFY, this must contain the full new content of the file after the change. For DELETE, this should be an empty string."
          }
        },
        "oneOf": [
          {
            "title": "ADD requires non-empty content",
            "properties": { "change_type": { "const": "ADD" }, "content": { "minLength": 1 } },
            "required": ["change_type", "content"]
          },
          {
            "title": "MODIFY requires non-empty content",
            "properties": { "change_type": { "const": "MODIFY" }, "content": { "minLength": 1 } },
            "required": ["change_type", "content"]
          },
          {
            "title": "DELETE requires empty content",
            "properties": { "change_type": { "const": "DELETE" }, "content": { "maxLength": 0 } },
            "required": ["change_type", "content"]
          }
        ]
      },
      "examples": [
        [
          {
            "file_path": "./src/components/RaceCar.tsx",
            "change_type": "ADD",
            "content": "export const RaceCar = () => <div>Vroom</div>;"
          },
          {
            "file_path": ".github/workflows/chimera-gate.yml",
            "change_type": "MODIFY",
            "content": "name: Chimera Gate\non: [pull_request]\njobs:\n  validate:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Validate\n        run: chimera validate"
          },
          {
            "file_path": "./server/auth/legacy-token.ts",
            "change_type": "DELETE",
            "content": ""
          }
        ]
      ]
    }
  }
}
